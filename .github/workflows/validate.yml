name: Validate LumaDeploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Validate repository structure
      run: |
        echo "üîç Validating LumaDeploy AI Service Builder repository..."
        
        # Check for required directories
        required_dirs=("terraform" "ansible" "kubernetes" "scripts" "docs")
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "‚úÖ Found required directory: $dir"
          else
            echo "‚ùå Missing required directory: $dir"
            exit 1
          fi
        done
        
        # Check for required files
        required_files=("README.md" "Makefile" "setup.sh")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ Found required file: $file"
          else
            echo "‚ùå Missing required file: $file"
            exit 1
          fi
        done
        
        echo "üéâ Repository structure validation passed!"
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.7.0'
        
    - name: Validate Terraform syntax
      run: |
        echo "üîß Validating Terraform configuration..."
        cd terraform
        terraform fmt -check
        terraform init -backend=false
        terraform validate
        echo "‚úÖ Terraform validation passed!"
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
        
    - name: Validate Python scripts
      run: |
        echo "üêç Validating Python scripts..."
        
        # Check Python syntax in proxmox tools
        if [ -d "proxmox/python-tools" ]; then
          cd proxmox/python-tools
          python -m py_compile *.py || echo "‚ö†Ô∏è  Some Python files have syntax issues (non-critical)"
          cd ../..
        fi
        
        echo "‚úÖ Python validation completed!"
        
    - name: Validate Ansible playbooks
      run: |
        echo "üìã Installing Ansible..."
        sudo apt-get update
        sudo apt-get install -y ansible
        
        echo "üîß Validating Ansible playbooks..."
        if [ -f "ansible/site-k3s.yml" ]; then
          ansible-playbook --syntax-check ansible/site-k3s.yml
          echo "‚úÖ Ansible K3s playbook syntax valid"
        fi
        
        if [ -f "ansible/site.yml" ]; then
          ansible-playbook --syntax-check ansible/site.yml
          echo "‚úÖ Ansible main playbook syntax valid"
        fi
        
        echo "‚úÖ Ansible validation passed!"
        
    - name: Validate Kubernetes manifests
      run: |
        echo "‚ò∏Ô∏è  Validating Kubernetes manifests..."
        
        # Check YAML syntax for Kubernetes files
        if [ -d "kubernetes" ]; then
          for file in kubernetes/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              python -c "import yaml; list(yaml.safe_load_all(open('$file')))" || {
                echo "‚ùå Invalid YAML in $file"
                exit 1
              }
            fi
          done
        fi
        
        echo "‚úÖ Kubernetes manifests validation passed!"
        
    - name: Validation summary
      run: |
        echo "üéâ LumaDeploy AI Service Builder validation completed successfully!"
        echo ""
        echo "‚úÖ Repository structure valid"
        echo "‚úÖ Terraform configuration valid"
        echo "‚úÖ Python scripts checked"
        echo "‚úÖ Ansible playbooks valid"
        echo "‚úÖ Kubernetes manifests valid"
        echo ""
        echo "üöÄ Ready for deployment!"

    # Optional: Send success notification to Slack
    # Uncomment and configure SLACK_WEBHOOK_URL secret to enable
    # - name: Notify success to Slack
    #   if: success()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: success
    #     channel: '#infrastructure'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
    #     fields: repo,message,commit,author,action,eventName,ref,workflow
    #     text: |
    #       ‚úÖ LumaDeploy validation passed!
    #       Branch: ${{ github.ref }}
    #       Commit: ${{ github.sha }}

    # Optional: Send failure notification to Slack
    # Uncomment and configure SLACK_WEBHOOK_URL secret to enable
    # - name: Notify failure to Slack
    #   if: failure()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: failure
    #     channel: '#infrastructure'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
    #     fields: repo,message,commit,author,action,eventName,ref,workflow
    #     text: |
    #       ‚ùå LumaDeploy validation failed!
    #       Branch: ${{ github.ref }}
    #       Commit: ${{ github.sha }}
    #       Please check the workflow logs.
