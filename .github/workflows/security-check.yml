name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security validation
      run: |
        chmod +x scripts/security-check-simple.sh
        ./scripts/security-check-simple.sh
        
    - name: Check for sensitive files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        
        # Check if .env files are being committed
        if git ls-files | grep -E "\.env$"; then
          echo "âŒ Found .env files - these contain sensitive data"
          echo "Please ensure these are in .gitignore"
          exit 1
        fi
        
        # Check if any .tfvars files are being committed
        if git ls-files | grep -E "\.tfvars$"; then
          echo "âŒ Found .tfvars files - these may contain sensitive data"
          echo "Please ensure these are in .gitignore"
          exit 1
        fi
        
        echo "âœ… .gitignore properly configured"
        
    - name: Verify infrastructure security
      run: |
        echo "ğŸ” Checking infrastructure configuration..."
        
        # Check if any hardcoded IP addresses exist in infrastructure files
        if find . -name "*.yml" -o -name "*.yaml" -o -name "*.sh" | grep -v .git | xargs grep -l "192\.168\.1\." 2>/dev/null; then
          echo "âš ï¸  Found hardcoded IP addresses in infrastructure files"
          echo "Consider using environment variables or configuration files"
          # This is a warning, not a failure for infrastructure management
        fi
        
        echo "âœ… Infrastructure configuration checked"
        
    - name: Security check passed
      run: |
        echo "ğŸ‰ All security checks passed!"
        echo "âœ… No sensitive data found"
        echo "âœ… Code is safe to merge"